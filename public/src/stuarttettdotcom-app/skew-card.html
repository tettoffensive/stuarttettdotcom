<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<!-- cubic-bezier(0.15, 0.005, 0.155, 1) -->
<dom-module id="skew-card">
  <template>
    <style>
    :host {
      cursor: pointer;
      background-color: #ffffff;
      color: #000;
      padding: 0px;
      overflow: hidden;
      padding: 1px;
      -webkit-backface-visibility:hidden;
      backface-visibility:hidden;
      -webkit-background-clip:content-box;
      background-clip:content-box;
      outline: 1px solid transparent;
      transform-origin: left top;
      /* transition: height 0.5s linear; */
      /* transition: box-shadow 0.5s linear; */

      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      align-items: flex-start;
    }

    :host(.front) {
      z-index: 100;
    }

    :host(.back) {
      z-index: 0;
    }

    :host(.initial) {
      transform: skewY(-3deg);
      height: 256px;
      width: 100%;
    }

    :host(.returning) {
      transform: skewY(-3deg);
      height: 256px;
      width: 100%;
    }

    :host::transitioning {
      pointer-events: none;
    }

    :host(.onclick) {
      height: 80%;
      width: 80%;
      position: absolute;
      left: 10%;
      top: 10%;
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.35);
    }

    :host(.initial) > * {
      transform: skewY(3deg);
    }

    .content {
      flex-grow: 1;
      flex-shrink: 1;
      position: relative;
      transform-origin: 0px 26px; /* should be 25px, but something is causing a bit of a jump */
    }

    .content img {
      margin: auto;
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
    }

    .content:before {
      display: block;
      content: ' ';
      width: 100%;
      padding-top: calc(503 / 578 * 100%);
    }

    .label {
      position: relative;
      top: -25px;
      left: 0;
      right: 0;
      overflow: hidden;
      background-color: #3F4A48;
      color: #ffffff;
      height: 112%;
      width: 280px;
      transform-origin: 0px 25px;
      z-index: 1;
    }

    .label .text {
      position: relative;
      left: 0;
      top: 0;
      right: 0;
      width: 280px;
      /* height: 100%; */
      transform-origin: 0px 6px;
    }

    /* .label:before {
    position: absolute;
    left: 0;
    top: -25px;
    transform: skewY(-3deg);
    content: '';
    transform-origin: left top;
    background-color: inherit;
    height: 50px;
    width: 100%;
    -webkit-backface-visibility: hidden;
    z-index: 5;
    } */

    .t2 {
      font-family: 'BioRhyme';
      font-weight: 800;
      font-style: normal;
      font-size: 18px;
      color: #FFFFFF;
      letter-spacing: 1px;
      text-align: left;
    }

    .d2 {
      font-family: 'Space Mono';
      font-size: 14px;
      font-weight: 400;
      font-style: italic;
    }

    .label p { padding: 20px; }
    /* :host(.initial):hover .label { width: 35%; } */
    :host(.initial):hover {
      /* height: 512px; */
    }

    </style>
    <div class="label">
      <div class="text">
        <p class="t2">[[title]]</p></a>
        <p class="d2">[[description]]</p>
      </div>
    </div>
    <div class="content">
      <img src="[[img]]" />
    </div>
  </template>

  <script>
  class SkewCard extends Polymer.Element {
    static get is() { return 'skew-card'; }
    static get properties() {
      return {
        title: {
          type: String,
          reflectToAttribute: true,
        },
        description: {
          type: String,
          reflectToAttribute: true,
        },
        img: {
          type: String,
          reflectToAttribute: true,
        },
        link: {
          type: String,
          reflectToAttribute: true,
        },
      }
    }

    ready() {
      this.classList.add('initial');
      this.classList.add('back');
      this.addEventListener('click', this._onClick);
      super.ready();
      this._defaultTitle = document.title;
    }

    constructor() {
      super();
      this._state = false;
      this._popState = this._popState.bind(this);
    }

    get defaultTitle() {
      return this._defaultTitle;
    }

    get state() {
      return this._state;
    }

    set transitionToState(value) {
      if (this._state == value) {
        throw "Trying to transition to an unsupported state";
      }
      this._state = value;
    }

    connectedCallback() {
      super.connectedCallback();
      window.addEventListener('popstate', this._popState);
    }

    disconnectedCallback() {
      super.disconnectedCallback();
      window.removeEventListener('popstate', this._popState);
    }

    _openCard() {
      this.transitionToState = true;
      var xhr = new XMLHttpRequest();
      xhr.open('GET', 'builduptv/index.html');
      xhr.onload = function() {
        if (xhr.status === 200) {
          // alert('hello there: ' + xhr.responseText);
          // var newContent = xhr.responseText.find('#content');
          // var newPage = $(newContent).attr('data-page');
          // var tempElement = document.createElement('div');
          // tempElement.innerHTML = data;
          // var styles = tempElement.querySelector('#ce-fontset').innerHTML;
          // document.querySelector('#ce-fontset').innerHTML = styles;
          //
          // $(newContent).addClass('ed-page--new');
          // $('#content').before(newContent);
          // pages.updateMetaData(newContent, oldPage);
          // pages.updatePath(newPage, href);
          // pages.checkExternalLinks();
          // casePage.init();
          // if (workCase) {
          //   pages.animateCase(oldPage, newPage, workCase);
          // } else {
          //   pages.animatePages(oldPage, newPage);
          // }
          // this.set('resolveUrl', event.target.value);
          // this.set('title', xhr.response.detail.response.title);
        } else {
          alert('Request failed.  Returned status of ' + xhr.status);
        }
      };

      // Calculate the time from starting to load the data for use in animation timing
      var startLoad = performance.now();
      xhr.send(); // send the request

      // FLIP animation
      // First
      let transform = this.style.transform;
      this.style.transform = "none"; // without skew
      let first = this.getBoundingClientRect();
      this.style.transform = transform; // restore skew
      // Last
      this.classList.replace('back','front');
      this.classList.replace('initial','onclick');
      let last = this.getBoundingClientRect();
      // Invert
      let deltaX = first.left - last.left;
      let deltaY = first.top - last.top;
      let deltaW = first.width / last.width;
      let deltaH = first.height / last.height;
      this.style.transform = `
      translate(${deltaX}px, ${deltaY}px)
      skewY(-3deg)
      scale(${deltaW}, ${deltaH})
      `;
      // Invert the children (double-inversion) so they look normal
      Array.from(this.shadowRoot.children).forEach( child => {
        child.style.transform = `
        scale(${1.0/deltaW}, ${1.0/deltaH})
        skewY(3deg)
        `;
      });
      // Now animate!
      var oldTransition = this.style.transition;
      setTimeout( () => {
        var children = this.shadowRoot.children;
        Array.from(this.shadowRoot.children).forEach( child => {
          child.style.transition = "transform 0.5s linear";
          child.style.transform = "";
        });
        this.style.transition = "transform 0.5s linear";
        this.style.transform = "";
      }, 10.0);

      document.title = "new title";
      history.pushState(null, null, "new-page");
    }

    _closeCard() {
      this.transitionToState = false;
      this.style.transition = "";
      this.style.transform = ""; // don't want to override class transform
      Array.from(this.shadowRoot.children).forEach( child => {
        child.style.transition = "";
        Array.from(child.children).forEach( child => {
          child.style.transition = "";
        });
      });
      // FLIP animation
      // First
      let first = this.getBoundingClientRect();
      // Last
      this.classList.replace('onclick','returning');
      let transform = this.style.transform;
      this.style.transform = ""; // without skew
      let last = this.getBoundingClientRect();
      this.style.transform = transform; // restore skew

      // Invert
      let deltaX = first.left - last.left;
      let deltaY = first.top - last.top;
      let deltaW = first.width / last.width;
      let deltaH = first.height / last.height;
      this.style.transform = `
      translate(${deltaX}px, ${deltaY}px)
      scale(${deltaW}, ${deltaH})
      `;

      // Invert the children (double-inversion) so they look normal
      Array.from(this.shadowRoot.children).forEach( child => {
        if (child.classList.contains('label')) {
          child.style.transform = `
          scale(${1.0/deltaW}, 1.0)
          `
          child.children[0].style.transform = `
          scale(1.0, ${1.0/deltaH})
          `;
        } else {
          child.style.transform = `
          scale(${1.0/deltaW}, ${1.0/deltaH})
          `
        }
      });

      // Now animate!
      var oldTransition = this.style.transition;
      setTimeout( () => {
        var children = this.shadowRoot.children;
        this.style.transition = "transform 0.5s linear";
        this.style.transform = transform;
        Array.from(this.shadowRoot.children).forEach( child => {
          if (child.classList.contains('label')) {
            // child.children[0].style.transition = "none";//transform 0.5s linear";
            setTimeout( () => {
            child.children[0].style.transform = "";
          },0);
          }
          // child.style.transition = "transform 0.5s linear";
          setTimeout( () => {
          child.style.transform = "";
        },0);
        });
        this.classList.replace('front','back');
        this.classList.replace('returning','initial');
      }, 10.0);

      document.title = this.defaultTitle;
    }

    _onClick(event) {
      if (event.target != event.currentTarget) {
        return;
      }
      event.preventDefault();
      this.state ? this._closeCard() : this._openCard();
    }

    _popState(event) {
      console.log(this.state);
      if (event.target != event.currentTarget || !this.state) {
        return; // event is window so this probably isn't necessary
      }
      this.state ? this._closeCard() : this._openCard();
    }

    _loadImage(img) {
      if (img && !img.src) {
        img.src = img.getAttribute('data-src');
      }
    }
  }
  window.customElements.define(SkewCard.is, SkewCard);
  </script>
</dom-module>
