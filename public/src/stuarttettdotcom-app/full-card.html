<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.20.4/TweenLite.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.20.4/TimelineLite.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.20.4/plugins/CSSPlugin.min.js"></script>
<!-- cubic-bezier(0.15, 0.005, 0.155, 1) -->
<dom-module id="full-card">
  <template>
    <style include="skew-style-module">
    /* In different browsers figure,p margin/padding is different */
    :host {
      --card-closed-height: 500px;

      transform-origin: left top;
      cursor: pointer;
      background-color: transparent;
      padding: 0px;
      /* Different browsers alias skewY differently - chrome kinda sucks */
      -webkit-backface-visibility:hidden;
      backface-visibility:hidden;
      /* -webkit-background-clip:content-box; */
      /* background-clip:content-box; */
      outline: 1px solid transparent;
      overflow: visible;
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      align-items: stretch;
    }
    </style>
    <div>
      <stt-close-btn on-click="_onClickClose"></stt-close-btn>
      <stt-scroll-btn on-click="_onClickScroll"></stt-scroll-btn>
      <div id="labelShadow" class="shadow z2 lbl-onclick">
        <div id="labelClip" class="clip dark-background">
          <div id="label" class="label">
            <div id="text" class="text clip">
              <p class="title">[[title]]</p></a>
              <p class="description">[[description]]</p>
            </div>
          </div>
        </div>
      </div>
      <div id="contentShrink" class="content-shrink shadow z1 ct-onclick">
        <div id="contentClip" class="clip">
          <figure id="content" class="content image cover" style="background-image: url([[img]])">
          </div>
        </div>
      </figure>
    </div>
  </template>

  <script>
  // otherwise GSAP skewY != css skewY https://greensock.com/docs/Plugins/CSSPlugin
  CSSPlugin.defaultSkewType = "simple";

  // Used for interpotalion in the animation for closing the card
  function remap(x, inMin, inMax, outMin, outMax) {
    let remap = (x - inMin) * (outMax - outMin) / (inMax - inMin) + outMin;
    return Math.min(Math.max(remap, outMin), outMax);
  }

  class FullCard extends Polymer.Element {
    static get is() { return 'full-card'; }
    static get properties() {
      return {
        title: {
          type: String,
          reflectToAttribute: true,
        },
        description: {
          type: String,
          reflectToAttribute: true,
        },
        img: {
          type: String,
          reflectToAttribute: true,
        },
        link: {
          type: String,
          reflectToAttribute: true,
        },
      }
    }

    ready() {
      // add default classes
      this.classList.add('onclick');
      this.classList.add('front');
      this.addEventListener('click', this._onClick);
      super.ready();
      // keep track of default title
      this._defaultTitle = document.title;
      // setTimeout(function() {
      console.log(this.$.label);
      let tl = new TimelineLite();
      tl.from(this.$.label, 1, { autoAlpha: 0}, 0)
      .from(this.$.content, 1, { autoAlpha: 0}, 0);
      // },0);
    }

    constructor() {
      super();
      // closed state = false
      this._state = true;
      // for history back and forward buttons
      this._popState = this._popState.bind(this);
    }

    get defaultTitle() {
      return this._defaultTitle;
    }

    get state() {
      return this._state;
    }

    set transitionToState(value) {
      if (this._state == value) {
        throw "Trying to transition to an unsupported state";
      }
      this._state = value;
    }

    connectedCallback() {
      super.connectedCallback();
      // for history back and forward buttons
      window.addEventListener('popstate', this._popState);
    }

    disconnectedCallback() {
      super.disconnectedCallback();
      // for history back and forward buttons
      window.removeEventListener('popstate', this._popState);
    }

    _onClickClose() {
      console.log("dispatch!!!");
      this.dispatchEvent(new CustomEvent('close', {}));
    }

    _onClickScroll() {

    }

    _popState(event) {
      if (event.target != event.currentTarget || !this.state) {
        return; // event is window so this probably isn't necessary
      }
      event.preventDefault();
      this._closeCard()
    }

    _loadImage(img) {
      if (img && !img.src) {
        img.src = img.getAttribute('data-src');
      }
    }
  }
  window.customElements.define(FullCard.is, FullCard);
</script>
</dom-module>
